<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <!-- ... (bagian head tetap sama) ... -->
</head>
<body>
  <!-- ... (bagian HTML tetap sama) ... -->

  <script>
    // === CONFIG — PERBAIKAN: HAPUS SPASI EKSTRA ===
    const SUPABASE_URL = 'https://fuovfrdicdhnlymnacpz.supabase.co'; // ✅ HAPUS SPASI DI AKHIR
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZmcmRpY2Robmx5bW5hY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjYxMzEsImV4cCI6MjA4MjYwMjEzMX0.oX4fVTEIWiRG2NaNJJKOV8dTnSHWhicLVMIFzZUl1o0';

    // === OLD FASHION WAY — DENGAN ERROR HANDLING ===
    async function supabaseFetch(table, method = 'GET', body = null, query = '') {
      try {
        const headers = {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        };

        let url = `${SUPABASE_URL}/rest/v1/${table}`;
        if (query) url += `?${query}`;
        
        let options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const res = await fetch(url, options);
        if (!res.ok) {
          const errorText = await res.text();
          console.error(`Supabase Error ${res.status}:`, errorText);
          throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 100)}`);
        }
        
        // Untuk DELETE yang tidak mengembalikan data
        if (method === 'DELETE' && res.status === 204) {
          return { success: true };
        }
        
        return await res.json();
      } catch (error) {
        console.error('Fetch error:', error);
        throw new Error(`Gagal menghubungi server: ${error.message}`);
      }
    }

    // === STATE ===
    const currentUser = localStorage.getItem('nope_username');
    if (!currentUser) {
      window.location.href = 'index.html';
    }
    document.getElementById('username-display').textContent = currentUser;

    let artefacts = [];
    let rants = [];

    // === UTILS ===
    function showConfirmation(msg) {
      const el = document.getElementById('confirmation');
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 3000);
    }

    function validateNotation(text) {
      const words = text.trim().split(/\s+/).filter(w => w.length > 0);
      return words.length >= 1 && words.length <= 4;
    }

    function showPostUploadPanel() {
      postUploadPanel.classList.remove('hidden');
      document.getElementById('hero-notation').value = '';
      document.getElementById('hero-notation').focus();
    }

    function hidePostUploadPanel() {
      postUploadPanel.classList.add('hidden');
    }

    // === DATABASE: pastikan user ada ===
    async function ensureUserExists() {
      try {
        // Cek apakah user sudah ada
        const users = await supabaseFetch('users', 'GET', null, `username=eq.${currentUser}`);
        
        if (!users || users.length === 0) {
          // User belum ada, buat baru
          await supabaseFetch('users', 'POST', { 
            username: currentUser,
            created_at: new Date().toISOString()
          });
          console.log('User baru dibuat:', currentUser);
        }
      } catch (e) {
        console.error('Gagal memastikan user:', e);
        // Tampilkan pesan error yang lebih informatif
        if (e.message.includes('relation "users" does not exist')) {
          alert('ERROR: Tabel "users" belum dibuat di Supabase. Buat tabel terlebih dahulu.');
        } else if (e.message.includes('failed to fetch')) {
          alert('ERROR: Tidak dapat terhubung ke database. Periksa koneksi internet dan URL Supabase.');
        }
      }
    }

    // === MUAT DATA ===
    async function loadData() {
      try {
        await ensureUserExists();

        // Load artefacts
        try {
          const artefactsData = await supabaseFetch('artefacts', 'GET', null, `username=eq.${currentUser}&order=created_at.desc&limit=6`);
          artefacts = artefactsData || [];
        } catch (artefactError) {
          console.warn('Gagal load artefak:', artefactError);
          artefacts = [];
        }

        // Load rants
        try {
          const rantsData = await supabaseFetch('rants', 'GET', null, `username=eq.${currentUser}&order=created_at.desc&limit=5`);
          rants = rantsData || [];
        } catch (rantError) {
          console.warn('Gagal load rants:', rantError);
          rants = [];
        }

        renderHero();
        renderDiary();
        renderTray();

      } catch (e) {
        console.error('Error saat load data:', e);
        showConfirmation("Gagal memuat data. Coba refresh.");
        
        // Tampilkan data dummy untuk testing
        if (artefacts.length === 0) {
          renderDiary();
          renderTray();
        }
      }
    }

    // === RENDER ===
    function renderHero() {
      const heroImg = document.getElementById('hero-img');
      const heroNotationDisplay = document.getElementById('hero-notation-display');
      const postUploadPanel = document.getElementById('post-upload-panel');

      if (artefacts.length > 0 && artefacts[0].image_url) {
        heroImg.src = artefacts[0].image_url;
        const notation = artefacts[0].notation || '';
        heroNotationDisplay.textContent = notation;
        if (notation) hidePostUploadPanel();
      } else {
        heroImg.src = 'https://placehold.co/384x480/111/333?text=+';
        heroNotationDisplay.textContent = '';
      }
    }

    function renderDiary() {
      const container = document.getElementById('diary');
      container.innerHTML = '';

      if (rants.length === 0) {
        container.innerHTML = '<div class="empty-state">Belum ada jejak. Tinggalkan jejak pertamamu!</div>';
        return;
      }

      rants.forEach(r => {
        const entry = document.createElement('div');
        entry.className = 'diary-entry';
        const date = new Date(r.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
        entry.innerHTML = `<time>${date}</time><p>${r.content}</p>`;
        container.appendChild(entry);
      });
    }

    function renderTray() {
      const tray = document.getElementById('tray');
      tray.innerHTML = '';

      if (artefacts.length === 0) {
        tray.innerHTML = '<div class="empty-state">Belum ada artefak. Unggah gambar pertamamu!</div>';
        return;
      }

      artefacts.slice(0, 6).forEach(a => {
        const div = document.createElement('div');
        div.className = 'tray-slot';
        if (a.image_url) {
          div.style.backgroundImage = `url(${a.image_url})`;
        }
        if (a.notation) {
          const notationEl = document.createElement('div');
          notationEl.className = 'artefak-notation';
          notationEl.textContent = a.notation;
          div.appendChild(notationEl);
        }
        tray.appendChild(div);
      });
    }

    // === UPLOAD ARTEFAK BARU ===
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validasi file
      if (!file.type.startsWith('image/')) {
        alert('Hanya file gambar yang diizinkan.');
        return;
      }

      if (file.size > 5 * 1024 * 1024) { // 5MB
        alert('Ukuran file maksimal 5MB.');
        return;
      }

      showConfirmation("Mengunggah...");
      
      try {
        // Upload langsung ke Supabase Storage
        const fileName = `${currentUser}/${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
        const formData = new FormData();
        formData.append('file', file);

        const uploadRes = await fetch(`${SUPABASE_URL}/storage/v1/object/artefacts/${fileName}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: formData
        });

        if (!uploadRes.ok) {
          const error = await uploadRes.json();
          throw new Error(error.message || 'Upload gagal');
        }

        const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/artefacts/${fileName}`;

        // Simpan ke tabel artefacts
        await supabaseFetch('artefacts', 'POST', {
          username: currentUser,
          image_url: imageUrl,
          notation: '',
          created_at: new Date().toISOString()
        });

        showConfirmation("Gambar diunggah! Tambahkan notasi (maks 4 kata).");
        await loadData();
        showPostUploadPanel();

        // Reset file input
        event.target.value = '';

      } catch (e) {
        console.error('Upload error:', e);
        showConfirmation("");
        alert(`Gagal mengunggah: ${e.message}`);
      }
    }

    // === SIMPAN NOTASI ===
    async function saveNotation() {
      const input = document.getElementById('hero-notation');
      const text = input.value.trim();

      if (!validateNotation(text)) {
        alert('Notasi harus 1–4 kata.');
        return;
      }

      if (artefacts.length === 0) {
        alert('Belum ada artefak.');
        return;
      }

      try {
        // Gunakan query parameter yang benar
        await supabaseFetch('artefacts', 'PATCH', {
          notation: text,
          updated_at: new Date().toISOString()
        }, `id=eq.${artefacts[0].id}`);

        showConfirmation("Notasi tersimpan.");
        await loadData();
        hidePostUploadPanel();

      } catch (e) {
        console.error('Notasi error:', e);
        alert(`Gagal menyimpan notasi: ${e.message}`);
      }
    }

    // === POST RANT ===
    async function postRant() {
      const content = document.getElementById('rant').value.trim();
      if (!content) {
        alert('Tuliskan sesuatu terlebih dahulu.');
        return;
      }
      
      if (content.length > 300) {
        alert('Maksimal 300 huruf.');
        return;
      }

      showConfirmation("Menyimpan...");

      try {
        await supabaseFetch('rants', 'POST', {
          username: currentUser,
          content,
          zone: 'neutral', // Kolom required
          created_at: new Date().toISOString()
        });

        document.getElementById('rant').value = '';
        showConfirmation("Jejakmu tersimpan.");
        await loadData();

      } catch (e) {
        console.error('Rant error:', e);
        
        if (e.message.includes('column "zone" of relation "rants" does not exist')) {
          alert('ERROR: Tambahkan kolom "zone" di tabel rants di Supabase.\n\n1. Buka Table Editor di Supabase\n2. Edit tabel "rants"\n3. Tambah kolom: zone (text, nullable: false, default: neutral)');
        } else {
          alert(`Gagal menyimpan jejak: ${e.message}`);
        }
        showConfirmation("");
      }
    }

    // === NAVIGASI & LOGOUT ===
    function navigateTo(page) {
      window.location.href = page;
    }

    function logout() {
      if (confirm('Keluar dari akun?')) {
        localStorage.removeItem('nope_username');
        window.location.href = 'index.html';
      }
    }

    // === INIT LISTENERS ===
    document.addEventListener('DOMContentLoaded', () => {
      // Upload
      document.getElementById('upload-artefak-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });
      document.getElementById('file-input').addEventListener('change', handleFileSelect);

      // Notasi
      document.getElementById('save-notation-btn').addEventListener('click', saveNotation);
      document.getElementById('hero-notation').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveNotation();
      });

      // Rant
      document.getElementById('jejakkan-btn').addEventListener('click', postRant);

      // Navigasi
      document.getElementById('nav-jejak').addEventListener('click', () => navigateTo('jejak.html'));
      document.getElementById('nav-frekuensi').addEventListener('click', () => navigateTo('frekuensi.html'));
      document.getElementById('nav-saynope').addEventListener('click', () => navigateTo('saynope.html'));
      document.getElementById('nav-glitch').addEventListener('click', () => navigateTo('glitch.html'));
      document.getElementById('settings-btn').addEventListener('click', logout);

      // Load data
      loadData();
    });
  </script>
</body>
</html>
